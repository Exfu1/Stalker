(function(T,r,c,t,M,y,f){"use strict";var v;let S;try{S=require("@vendetta/commands")}catch{r.logger.log("Commands API not available")}const{FormSection:I,FormRow:g,FormInput:q,FormDivider:ye}=M.Forms,{ScrollView:z,View:Y,Text:P,TouchableOpacity:H,ActivityIndicator:W,Linking:J}=M.General,G=J||((v=t.ReactNative)==null?void 0:v.Linking),F=c.findByStoreName("UserStore"),w=c.findByStoreName("GuildStore"),O=c.findByStoreName("GuildMemberStore"),j=c.findByStoreName("ChannelStore"),m=c.findByStoreName("RelationshipStore"),C=c.findByProps("getAPIBaseURL","get")||c.findByProps("API_HOST","get"),N=c.findByProps("transitionToGuild","transitionTo")||c.findByProps("transitionTo")||c.findByProps("replaceWith","back")||c.findByProps("openURL"),$=c.findByProps("jumpToMessage")||c.findByProps("fetchMessages","jumpToMessage");c.findByProps("selectChannel")||c.findByProps("selectVoiceChannel","selectChannel");let x="",U=null;const d={NONE:0,FRIEND:1,BLOCKED:2,PENDING_INCOMING:3,PENDING_OUTGOING:4,IMPLICIT:5};function Z(e){var n,s,i,h,u;try{if(!m)return r.logger.warn("RelationshipStore not found"),null;const a=(u=(h=(n=m.getRelationshipType)==null?void 0:n.call(m,e))!=null?h:(i=(s=m.getRelationship)==null?void 0:s.call(m,e))==null?void 0:i.type)!=null?u:d.NONE;return{type:a,isFriend:a===d.FRIEND,isBlocked:a===d.BLOCKED,hasPendingIncoming:a===d.PENDING_INCOMING,hasPendingOutgoing:a===d.PENDING_OUTGOING,label:Q(a),emoji:X(a)}}catch(a){return r.logger.error("Error getting relationship:",a),null}}function Q(e){switch(e){case d.FRIEND:return"Friend";case d.BLOCKED:return"Blocked";case d.PENDING_INCOMING:return"Pending (Incoming)";case d.PENDING_OUTGOING:return"Pending (Outgoing)";default:return"Not Friends"}}function X(e){switch(e){case d.FRIEND:return"\u2705";case d.BLOCKED:return"\u{1F6AB}";case d.PENDING_INCOMING:return"\u{1F4E8}";case d.PENDING_OUTGOING:return"\u{1F4E4}";default:return"\u274C"}}function _(e){try{const n=w?Object.values(w.getGuilds()||{}):[],s=[];for(const i of n)O?.getMember(i.id,e)&&s.push(i);return s}catch(n){return r.logger.error("Error getting mutual guilds:",n),[]}}function ee(e,n,s){const i=`https://discord.com/channels/${e}/${n}/${s}`,h=`discord://-/channels/${e}/${n}/${s}`;r.logger.log("Attempting to open:",h);try{t.FluxDispatcher&&(t.FluxDispatcher.dispatch({type:"NAVIGATE_TO_JUMP_TO_MESSAGE",messageId:s,channelId:n,guildId:e}),r.logger.log("FluxDispatcher NAVIGATE_TO_JUMP_TO_MESSAGE dispatched"))}catch(u){r.logger.error("FluxDispatcher method failed:",u)}try{if($!=null&&$.jumpToMessage)return $.jumpToMessage({channelId:n,messageId:s,flash:!0}),r.logger.log("jumpToMessage called"),!0}catch(u){r.logger.error("jumpToMessage method failed:",u)}try{if(N!=null&&N.transitionToGuild)return N.transitionToGuild(e,n,s),r.logger.log("transitionToGuild called"),!0;if(N!=null&&N.transitionTo)return N.transitionTo(`/channels/${e}/${n}/${s}`),r.logger.log("transitionTo called"),!0}catch(u){r.logger.error("Router method failed:",u)}try{if(G!=null&&G.openURL)return G.openURL(h),r.logger.log("openURL called with discord:// scheme"),!0}catch(u){r.logger.error("URL opener method failed:",u)}try{if(t.FluxDispatcher)return t.FluxDispatcher.dispatch({type:"MESSAGE_LINK_PRESSED",href:i}),r.logger.log("MESSAGE_LINK_PRESSED dispatched"),!0}catch(u){r.logger.error("MESSAGE_LINK_PRESSED dispatch failed:",u)}return!1}async function K(e,n){var s;try{if(!(C!=null&&C.get))return r.logger.error("RestAPI not found"),[];const i=await C.get({url:`/guilds/${e}/messages/search`,query:{author_id:n,include_nsfw:!0}});return(s=i?.body)!=null&&s.messages?i.body.messages.map(function(h){var u;const a=h[0];return{id:a.id,content:a.content||"[No text content]",channelId:a.channel_id,guildId:e,timestamp:a.timestamp,attachments:((u=a.attachments)==null?void 0:u.length)||0}}):[]}catch(i){return i?.status!==403&&r.logger.error(`Error searching guild ${e}:`,i?.message||i),[]}}function te(e){try{const n=j?.getChannel(e);return n?.name||"unknown"}catch{return"unknown"}}function ne(e){try{const n=w?.getGuild(e);return n?.name||"Unknown Server"}catch{return"Unknown Server"}}function re(e){try{const n=F?.getUser(e);if(n)return{username:n.username,globalName:n.globalName,id:n.id,avatar:n.avatar,discriminator:n.discriminator}}catch(n){r.logger.error("Error getting user info:",n)}return null}function le(){const[e,n]=t.React.useState(x),[s,i]=t.React.useState([]),[h,u]=t.React.useState(null),[a,oe]=t.React.useState(null),[L,ue]=t.React.useState([]),[R,D]=t.React.useState(!1),[V,k]=t.React.useState(""),ce=async function(){if(!e||e.length<17){f.showToast("Enter a valid User ID (17-19 digits)",y.getAssetIDByName("Small"));return}D(!0),i([]),k("Finding user info..."),x=e;try{const l=re(e);u(l);const o=Z(e);oe(o),r.logger.log("Relationship status:",o),k("Finding mutual servers...");const p=_(e);if(ue(p),p.length===0){f.showToast("No mutual servers found",y.getAssetIDByName("Small")),D(!1);return}const b=[];for(let E=0;E<Math.min(p.length,15);E++){const B=p[E];k(`${B.name} (${E+1}/${Math.min(p.length,15)})`);try{const A=await K(B.id,e);b.push(...A)}catch{}E<p.length-1&&await new Promise(function(A){return setTimeout(A,400)})}b.sort(function(E,B){return new Date(B.timestamp).getTime()-new Date(E.timestamp).getTime()}),i(b.slice(0,50)),f.showToast(`Found ${b.length} messages`,y.getAssetIDByName("Check"))}catch(l){f.showToast("Error: "+(l?.message||"Unknown"),y.getAssetIDByName("Small"))}finally{D(!1),k("")}},ge=async function(l){D(!0),k(`Searching ${l.name}...`);try{const o=await K(l.id,e);o.sort(function(p,b){return new Date(b.timestamp).getTime()-new Date(p.timestamp).getTime()}),i(o),f.showToast(`Found ${o.length} messages`,y.getAssetIDByName("Check"))}catch(o){f.showToast("Error: "+(o?.message||"Unknown"),y.getAssetIDByName("Small"))}finally{D(!1),k("")}},de=function(l){try{const o=new Date(l);return`${o.toLocaleDateString()} ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}catch{return l}},he=function(l){if(r.logger.log(`Tapping message: ${l.id} in channel ${l.channelId}`),f.showToast("Opening message...",y.getAssetIDByName("Check")),!ee(l.guildId,l.channelId,l.id)){const o=`https://discord.com/channels/${l.guildId}/${l.channelId}/${l.id}`;f.showToast("Navigation failed, check logs",y.getAssetIDByName("Small")),r.logger.log("Navigation failed. Message link:",o)}};return t.React.createElement(z,{style:{flex:1,backgroundColor:"#1e1f22"}},[t.React.createElement(I,{key:"search",title:"\u{1F50D} USER SEARCH"},[t.React.createElement(q,{key:"input",title:"User ID",placeholder:"Enter Discord User ID",value:e,onChangeText:n,keyboardType:"numeric"}),t.React.createElement(g,{key:"searchBtn",label:R?"\u23F3 Searching...":"\u{1F50D} Search All Servers",subLabel:R?V:"Find messages across mutual servers",onPress:R?void 0:ce})]),h&&t.React.createElement(I,{key:"userInfo",title:"\u{1F464} USER INFO"},[t.React.createElement(g,{key:"name",label:h.globalName||h.username||"Unknown",subLabel:`@${h.username} \u2022 ID: ${h.id}`}),a&&t.React.createElement(g,{key:"relationship",label:`${a.emoji} ${a.label}`,subLabel:a.isFriend?"You are friends with this user":a.isBlocked?"You have blocked this user":a.hasPendingIncoming?"This user sent you a friend request":a.hasPendingOutgoing?"You sent this user a friend request":"You are not friends with this user"})]),L.length>0&&t.React.createElement(I,{key:"servers",title:`\u{1F3E0} MUTUAL SERVERS (${L.length})`},L.slice(0,20).map(function(l,o){return t.React.createElement(g,{key:`s-${o}`,label:l.name,trailing:g.Arrow?t.React.createElement(g.Arrow,null):null,onPress:function(){return ge(l)}})})),R&&t.React.createElement(Y,{key:"loading",style:{padding:20,alignItems:"center"}},[t.React.createElement(W,{key:"spin",size:"large",color:"#5865f2"}),t.React.createElement(P,{key:"txt",style:{color:"#b5bac1",marginTop:10}},V)]),!R&&s.length>0&&t.React.createElement(I,{key:"msgs",title:`\u{1F4AC} MESSAGES (${s.length})`},s.map(function(l,o){return t.React.createElement(H,{key:`m-${o}`,style:{padding:12,borderBottomWidth:1,borderBottomColor:"#3f4147",backgroundColor:"#2b2d31"},onPress:function(){return he(l)},activeOpacity:.7},[t.React.createElement(P,{key:"ch",style:{color:"#5865f2",fontSize:12,marginBottom:2}},`#${te(l.channelId)} \u2022 ${ne(l.guildId)}`),t.React.createElement(P,{key:"ct",style:{color:"#f2f3f5",fontSize:14,marginBottom:4}},l.content.length>150?l.content.substring(0,150)+"...":l.content),t.React.createElement(P,{key:"tm",style:{color:"#949ba4",fontSize:11}},de(l.timestamp)+(l.attachments>0?` \u2022 \u{1F4CE}${l.attachments}`:"")+" \u2022 Tap to open")])})),t.React.createElement(I,{key:"debug",title:"\u{1F527} DEBUG INFO"},[t.React.createElement(g,{key:"relStore",label:"RelationshipStore",subLabel:m?"\u2705 Found":"\u274C Not Found"}),t.React.createElement(g,{key:"userStore",label:"UserStore",subLabel:F?"\u2705 Found":"\u274C Not Found"}),t.React.createElement(g,{key:"cmdApi",label:"Commands API",subLabel:S?"\u2705 Available":"\u274C Not Available"})]),!R&&s.length===0&&t.React.createElement(I,{key:"help",title:"\u2139\uFE0F HOW TO USE"},[t.React.createElement(g,{key:"h1",label:"1. Get User ID",subLabel:"Long-press user \u2192 Copy ID (enable Developer Mode)"}),t.React.createElement(g,{key:"h2",label:"2. Search",subLabel:"Paste ID and tap Search All Servers"}),t.React.createElement(g,{key:"h3",label:"3. View Results",subLabel:"See friend status, mutual servers & messages"}),t.React.createElement(g,{key:"h4",label:"4. Tap Message",subLabel:"Opens message location in Discord"})])])}const ae=le,ie=function(){if(r.logger.log("Stalker Pro loaded"),r.logger.log("RelationshipStore found:",!!m),r.logger.log("UserStore found:",!!F),r.logger.log("GuildMemberStore found:",!!O),r.logger.log("Commands API found:",!!S),S!=null&&S.registerCommand)try{U=S.registerCommand({name:"stalk",displayName:"stalk",description:"Open Stalker Pro to search for a user",displayDescription:"Open Stalker Pro settings to search for user messages",type:1,inputType:1,options:[],execute:async function(e,n){return f.showToast("Open plugin settings to use Stalker Pro",y.getAssetIDByName("Check")),{content:"Open Stalker Pro from plugin settings to search!"}}}),r.logger.log("Stalk command registered")}catch(e){r.logger.error("Failed to register command:",e)}f.showToast("Stalker Pro ready!",y.getAssetIDByName("Check"))},se=function(){if(r.logger.log("Stalker Pro unloaded"),U)try{U(),r.logger.log("Stalk command unregistered")}catch(e){r.logger.error("Failed to unregister command:",e)}};return T.onLoad=ie,T.onUnload=se,T.settings=ae,T})({},vendetta,vendetta.metro,vendetta.metro.common,vendetta.ui.components,vendetta.ui.assets,vendetta.ui.toasts);
